# شکنک (Shecanak)

**سرویس [شکن](https://shecan.ir) شخصی خود را بسازید.**

با استفاده از این پروژه می‌توانید با پراکسی کردن دامنه‌های خاص، DNS شخصی خود را با قابلیت ضد تحریم راه‌اندازی کنید.

**توجه:** این پروژه شامل تنظیمات و اسکریپت‌های نصب (شامل راه‌اندازی با Docker) برای ساده‌سازی استقرار [mosajjal/sniproxy](https://github.com/mosajjal/sniproxy) است. تمام اعتبار متعلق به [علی مسجل](https://github.com/mosajjal) است.

**توجه:** از این سرویس به عنوان VPN استفاده نکنید، IP شما **مسدود** خواهد شد؛ **فقط** برای دامنه‌هایی که به دلیل **تحریم‌ها** در دسترس نیستند (مانند npm، pytorch، tensorflow و غیره) استفاده کنید.

## راه‌اندازی

یکی از روش‌های زیر را برای راه‌اندازی شکنک انتخاب کنید:

### روش ۱: استفاده از Docker (توصیه شده)

۱. اطمینان حاصل کنید که Docker و Docker Compose نصب شده باشند.

۲. این مخزن را کلون کنید:

```bash
git clone https://github.com/yjavaherian/shecanak --depth 1
cd shecanak
```

۳. دامنه‌هایی را که می‌خواهید پراکسی شوند به فایل `domains.csv` اضافه کنید، هر دامنه در یک خط.

۴. کانتینرها را در حالت detached بسازید و اجرا کنید:

```bash
docker compose up -d --build
```

سرور DNS شما روی پورت 53 اجرا خواهد شد.

### روش ۲: استفاده از اسکریپت نصب (مبتنی بر Debian)

این روش از یک اسکریپت برای نصب `sniproxy` استفاده می‌کند.

**توجه:** این اسکریپت عمدتاً برای توزیع‌های لینوکس مبتنی بر Debian (مانند Ubuntu، Debian) طراحی شده است. ممکن است برای سیستم‌های دیگر نیاز به تغییراتی داشته باشد.

۱. این مخزن را کلون کنید:

```bash
git clone https://github.com/yjavaherian/shecanak --depth 1
cd shecanak
```

۲. دامنه‌هایی را که می‌خواهید پراکسی شوند به فایل `domains.csv` اضافه کنید، هر دامنه در یک خط.

۳. اسکریپت نصب را قابل اجرا کنید:

```bash
chmod +x install_sniproxy.sh
```

۴. اسکریپت نصب را با دسترسی روت اجرا کنید:

```bash
sudo ./install_sniproxy.sh
```

سرور DNS شما روی پورت 53 اجرا خواهد شد.

## عیب‌یابی: تداخل پورت 53 با systemd-resolved

در برخی توزیع‌های لینوکس (مانند Ubuntu 18.04 و بالاتر)، سرویس `systemd-resolved` یک شنونده DNS محلی (stub listener) را روی `127.0.0.53:53` اجرا می‌کند. این می‌تواند با شکنک تداخل ایجاد کند اگر بخواهد به پورت 53 متصل شود (چه مستقیماً از طریق روش اسکریپت یا از طریق Docker).

اگر هنگام شروع سرویس یا کانتینر Docker با خطاهایی مانند "port already in use" یا "address already in use" برای پورت 53 مواجه شدید، مراحل زیر را برای غیرفعال کردن شنونده stub سرویس `systemd-resolved` دنبال کنید:

۱. **بررسی کنید که آیا systemd-resolved از پورت 53 استفاده می‌کند:**

```bash
sudo ss -lp 'sport = :53'
# یا با استفاده از lsof
# sudo lsof -i :53
```

اگر `systemd-resolve` را در لیست مشاهده کردید، به این معنی است که پورت را اشغال کرده است.

۲. **فایل پیکربندی resolved را ویرایش کنید:**
فایل پیکربندی را با استفاده از یک ویرایشگر متن با دسترسی روت باز کنید:

```bash
sudo nano /etc/systemd/resolved.conf
```

۳. **شنونده stub را غیرفعال کنید:**
خط `#DNSStubListener=yes` را پیدا کنید (ممکن است کامنت شده باشد). آن را از حالت کامنت خارج کنید (علامت `#` را حذف کنید) و `yes` را به `no` تغییر دهید:

```
[Resolve]
#DNS=
#FallbackDNS=
#Domains=
#LLMNR=no
#MulticastDNS=no
#DNSSEC=no
#DNSOverTLS=no
#Cache=no-negative
DNSStubListener=no # <-- این خط را تغییر دهید
#ReadEtcHosts=yes
```

فایل را ذخیره کرده و از ویرایشگر خارج شوید (Ctrl+X، سپس Y، سپس Enter در `nano`).

۴. **سرویس systemd-resolved را مجدداً راه‌اندازی کنید:**
تغییرات را با راه‌اندازی مجدد سرویس اعمال کنید:

```bash
sudo systemctl restart systemd-resolved
```

۵. **تأیید کنید که پورت 53 آزاد است:**
دستور بررسی را دوباره اجرا کنید:

```bash
sudo ss -lp 'sport = :53'
# یا
# sudo lsof -i :53
```

دیگر نباید `systemd-resolve` را در حال گوش دادن به پورت 53 ببینید.

۶. **فایل `/etc/resolv.conf` را به‌روزرسانی کنید (مهم):**
غیرفعال کردن شنونده stub به این معنی است که سیستم شما ممکن است پیکربندی DNS خود را از دست بدهد، زیرا `/etc/resolv.conf` اغلب به شنونده stub (`127.0.0.53`) اشاره می‌کند. شما باید DNS سیستم خود را به صورت دستی پیکربندی کنید یا اطمینان حاصل کنید که مدیر شبکه شما (مانند NetworkManager یا systemd-networkd) فایل `/etc/resolv.conf` را به درستی به‌روزرسانی می‌کند.

- **گزینه الف (توصیه شده در صورت استفاده از NetworkManager):** اطمینان حاصل کنید که NetworkManager برای مدیریت `/etc/resolv.conf` پیکربندی شده است. اغلب، راه‌اندازی مجدد NetworkManager کمک می‌کند: `sudo systemctl restart NetworkManager`. پس از آن فایل `/etc/resolv.conf` را بررسی کنید. اکنون باید به سرورهای DNS واقعی بالادستی شما (مانند روتر شما یا DNS عمومی مانند 1.1.1.1) اشاره کند.
- **گزینه ب (دستی):** ممکن است لازم باشد فایل `/etc/resolv.conf` را به صورت دستی ویرایش کنید یا تنظیمات رابط شبکه خود را برای استفاده از سرورهای DNS خاص پیکربندی کنید. _در این مورد محتاط باشید، زیرا تنظیمات نادرست می‌تواند تفکیک نام DNS را مختل کند._ یک راه حل موقت رایج این است:
  ```bash
  # مثال: استفاده از DNS کلودفلر
  echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
  echo "nameserver 1.0.0.1" | sudo tee -a /etc/resolv.conf
  ```
  توجه داشته باشید که این فایل ممکن است توسط ابزارهای مدیریت شبکه بازنویسی شود.

پس از تکمیل این مراحل، پورت 53 باید برای شکنک در دسترس باشد. اکنون می‌توانید دوباره سرویس را شروع کنید یا `docker compose up -d` را اجرا کنید.
